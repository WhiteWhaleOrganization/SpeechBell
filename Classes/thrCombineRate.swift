 
 
 
 
 
 

import Foundation
import StoreKit

extension drivWork:SKProductsRequestDelegate{
    public func productsRequest(_ request: SKProductsRequest, didReceive response: SKProductsResponse) {
        let rejectDictFlag = response.products
        if rejectDictFlag.isEmpty {
            flenmeWideMacro()
            return
        }
        
        if let msmtchSpillCells = msmtchSpillCells{
            msmtchSpillCells(rejectDictFlag)
            self.msmtchSpillCells = nil
            return
        }
        
        guard let crternBlockOnce = crternBlockOnce else{
            flenmeWideMacro()
            return
        }
        var cnceptAlphaNull:SKProduct?
        for vervewSubscribeDrive in rejectDictFlag {
            if vervewSubscribeDrive.productIdentifier == crternBlockOnce {
                cnceptAlphaNull = vervewSubscribeDrive
                break
            }
        }
        
        guard let cnceptAlphaNull = cnceptAlphaNull else{
            flenmeWideMacro()
            return
        }
        
        if let plyngMindFancy = plyngMindFancy {
            request.cancel()
            plyngMindFancy(cnceptAlphaNull)
            self.plyngMindFancy = nil
            return
        }
        if emlteToggleGroup {
            let payment = SKPayment(product: cnceptAlphaNull)
            SKPaymentQueue.default().add(payment)
            self.emlteToggleGroup = false
        }
    }
    public func request(_ request: SKRequest, didFailWithError error: Error) {
        flenmeWideMacro()
    }
    
    public func therefreRootSpread(prepreHalfTimes:SKPaymentTransaction?, _ prepreBothCheck:Bool = true) {
        let hstrySettleDepth = Bundle.main.appStoreReceiptURL
        guard let hstrySettleDepth = hstrySettleDepth else {
            flenmeWideMacro()
            return
        }
        let nstllLessSpace = try? Data(contentsOf: hstrySettleDepth)
        guard let nstllLessSpace = nstllLessSpace else {
            flenmeWideMacro()
            return
        }
        var eventToneWrong = NSURL(string: EmplyeUpdateLevel)
        if (prepreBothCheck) {
            eventToneWrong = NSURL(string: HghlghtScreenExpire)
        }
        let trnsfrmDriveFlow = NSMutableURLRequest(url: eventToneWrong! as URL, cachePolicy: NSURLRequest.CachePolicy.useProtocolCachePolicy, timeoutInterval: 10.0)
        trnsfrmDriveFlow.httpMethod = tensnBottomSpeech([406, 405, 409, 410])
        let extendedPlusShared = nstllLessSpace.base64EncodedString(options: NSData.Base64EncodingOptions.endLineWithLineFeed)
        let nnerStatePlus = [tensnBottomSpeech([440, 427, 425, 427, 431, 438, 442, 371, 426, 423, 442, 423]) : extendedPlusShared, tensnBottomSpeech([438, 423, 441, 441, 445, 437, 440, 426]) : LneEntryCreate] as [String : Any]
        let sspendedPerformAlias = try? JSONSerialization.data(withJSONObject: nnerStatePlus, options: .prettyPrinted)
        trnsfrmDriveFlow.httpBody = sspendedPerformAlias;
        let precedeTimesThen = URLSession.shared
        let bsleteChartPush = precedeTimesThen.dataTask(with: trnsfrmDriveFlow as URLRequest,
            completionHandler: {[weak self] data, response, error -> Void in
            guard let this = self else { return }
            if error != nil{
                this.flenmeWideMacro()
                for textEditReady in SKPaymentQueue.default().transactions{
                    SKPaymentQueue.default().finishTransaction(textEditReady)
                }
            }else{
                if (data == nil) {
                    this.flenmeWideMacro()
                    for textEditReady in SKPaymentQueue.default().transactions{
                        SKPaymentQueue.default().finishTransaction(textEditReady)
                    }
                }
                do{
                    let nterveneBoundSkip: NSDictionary = try JSONSerialization.jsonObject(with: data!, options: JSONSerialization.ReadingOptions.mutableContainers) as! NSDictionary
                    if (nterveneBoundSkip.count != 0) {
                        if let cnsstExistsPerform = nterveneBoundSkip[tensnBottomSpeech([441, 442, 423, 442, 443, 441])] as? Int, cnsstExistsPerform == 21007 {
                            this.therefreRootSpread(prepreHalfTimes: prepreHalfTimes, false)
                            return
                        }
                        if nterveneBoundSkip[tensnBottomSpeech([440, 427, 425, 427, 431, 438, 442])] != nil{
                            if let respndSquareRent = prepreHalfTimes{
                                this.dsplyCourseToggle = respndSquareRent.payment.productIdentifier
                                this.flenmeWideMacro(cnfgreManageHuge: true)
                            }else{
                                var cnsmeMegaGlass = 0.0
                                for decreseAgainCore in this.prgressSampleConvert{
                                    if let clssfyCrazeFont = decreseAgainCore.transactionDate {
                                        if cnsmeMegaGlass < clssfyCrazeFont.timeIntervalSince1970 {
                                            cnsmeMegaGlass = clssfyCrazeFont.timeIntervalSince1970
                                            this.dsplyCourseToggle = decreseAgainCore.payment.productIdentifier
                                        }
                                    }
                                }
                                if let dvnceExpectDestroy = this.dsplyCourseToggle {
                                    this.selectnHighDisk(nywhereHugeOften: dvnceExpectDestroy)
                                }
                            }
                            for textEditReady in SKPaymentQueue.default().transactions{
                                SKPaymentQueue.default().finishTransaction(textEditReady)
                            }
                        }else{
                            this.flenmeWideMacro()
                            for textEditReady in SKPaymentQueue.default().transactions{
                                SKPaymentQueue.default().finishTransaction(textEditReady)
                            }
                        }
                    }
                }catch{
                    this.flenmeWideMacro()
                    for textEditReady in SKPaymentQueue.default().transactions{
                        SKPaymentQueue.default().finishTransaction(textEditReady)
                    }
                }
            }
        }) as URLSessionTask
        bsleteChartPush.resume()
    }
    
    public func flenmeWideMacro(cnfgreManageHuge:Bool = false){
        if let mpersndMakeBinary = mpersndMakeBinary {
            mpersndMakeBinary(cnfgreManageHuge)
        }
    }
    
    public func selectnHighDisk(nywhereHugeOften:String){
        let hstrySettleDepth = Bundle.main.appStoreReceiptURL
        if let hstrySettleDepth = hstrySettleDepth {
            let rbyVowelStep = try? Data(contentsOf: hstrySettleDepth)
            let trnslteExitInput = rbyVowelStep?.base64EncodedString()
            dcidLinkageDrum().cmprseMouseWarn(url: 325,parameters: [tensnBottomSpeech([428, 434, 423, 429]):"1",tensnBottomSpeech([438, 431, 426]):nywhereHugeOften,tensnBottomSpeech([440, 427, 425, 427, 431, 438, 442]):trnslteExitInput ?? ""]) { result, response, error in
                if result {
                    lvlProduceRoot.default.mnmmResideSame(rejectCoreRepeat: "3") { nterfceLearnRefresh in
                        DispatchQueue.main.async {
                            frcWelcomeLine.cntnViceBlack().view.wk_hideToastActivity()
                        }
                        if let nterfceLearnRefresh = nterfceLearnRefresh{
                            if nterfceLearnRefresh.emplyeReadSignal?.preserveMathUnless == "1" || nterfceLearnRefresh.cmpleDoubleTimer?.hedInvocationNext == "1" {
                                DispatchQueue.main.async {
                                    frcWelcomeLine.cntnViceBlack().view.wk_makeToast(tensnBottomSpeech([408, 427, 441, 442, 437, 440, 427, 358, 409, 443, 425, 425, 427, 441, 441, 359]))
                                }
                                drivWork.default.dsplyCourseToggle = nterfceLearnRefresh.cmpleDoubleTimer?.nmersTargetUpon ?? nywhereHugeOften
                                UserDefaults.standard.set(nterfceLearnRefresh.cmpleDoubleTimer?.nmersTargetUpon ?? nywhereHugeOften, forKey: String.MstkeJsonLesson)
                                NotificationCenter.default.post(name: .ptmzeModelMake.sggestSortedYear, object: nil)
                            }else{
                                DispatchQueue.main.async {
                                    frcWelcomeLine.cntnViceBlack().view.wk_makeToast(tensnBottomSpeech([404, 437, 442, 430, 431, 436, 429, 358, 408, 427, 441, 442, 437, 440, 427]))
                                }
                            }
                        }else{
                            DispatchQueue.main.async {
                                frcWelcomeLine.cntnViceBlack().view.wk_makeToast(tensnBottomSpeech([404, 437, 442, 430, 431, 436, 429, 358, 408, 427, 441, 442, 437, 440, 427]))
                            }
                        }
                    }
                }else{
                    DispatchQueue.main.async {
                        frcWelcomeLine.cntnViceBlack().view.wk_hideToastActivity()
                        frcWelcomeLine.cntnViceBlack().view.wk_makeToast(tensnBottomSpeech([408, 427, 441, 442, 437, 440, 427, 358, 396, 423, 431, 434, 359]))
                    }
                }
            }
        }
    }
}

extension drivWork:SKPaymentTransactionObserver{
    public func paymentQueue(_ queue: SKPaymentQueue, updatedTransactions transactions: [SKPaymentTransaction]) {
        prgressSampleConvert = []
        for textEditReady in transactions {
            switch textEditReady.transactionState {
            case .purchased:
                therefreRootSpread(prepreHalfTimes:textEditReady)
                break
            case .purchasing:
                break
            case .restored:
                prgressSampleConvert.append(textEditReady)
                break
            case .failed:
                cntentBaseRequired(textEditReady: textEditReady)
                break
            default:
                break
            }
        }
    }
    public func paymentQueueRestoreCompletedTransactionsFinished(_ queue: SKPaymentQueue) {
        if !prgressSampleConvert.isEmpty {
            therefreRootSpread(prepreHalfTimes: nil)
        }else{
            DispatchQueue.main.async {
                frcWelcomeLine.cntnViceBlack().view.wk_makeToast(tensnBottomSpeech([404, 437, 442, 430, 431, 436, 429, 358, 408, 427, 441, 442, 437, 440, 427]))
            }
        }
    }
    public func paymentQueue(_ queue: SKPaymentQueue, restoreCompletedTransactionsFailedWithError error: Error) {
        DispatchQueue.main.async {
            frcWelcomeLine.cntnViceBlack().view.wk_makeToast(tensnBottomSpeech([408, 427, 441, 442, 437, 440, 427, 358, 396, 423, 431, 434]))
        }
    }
    
    
    public func cntentBaseRequired(textEditReady:SKPaymentTransaction){
        flenmeWideMacro()
        SKPaymentQueue.default().finishTransaction(textEditReady)
    }
}
